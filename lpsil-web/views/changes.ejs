<% var title = 'Account Settings' %>
<% include head %>
<script>
    computeAge = function(e) {
        try{
            var today = Date.now();
            var birthday = Date.parse(document.getElementById("birthdate").valueAsDate);
            var age = new Date(today).getYear() - new Date(birthday).getYear();
            if (new Date(today).getMonth() < new Date(birthday).getMonth()) { age -= 1; }
            else if (new Date(today).getMonth() == new Date(birthday).getMonth()) {
                if (new Date(today).getDate() < new Date(birthday).getDate()) { age -= 1; }
            }
            document.getElementById("age").value = age;
        } catch(e) { document.getElementById("age").value = ""; }
    }
    loadProfilePic = function (e) {
        var canvas = document.getElementById("preview");
        var ctx = canvas.getContext("2d");
        ctx.fillRect(0,0,canvas.width,canvas.height);
        canvas.width=0;
        canvas.height=0;
        var file = document.getElementById("profilepicfile").files[0];
        var img = document.createElement("img");
        var reader = new FileReader();
        reader.onload = function(e) {
            if (!file.type.match(/image.*/)) {
                document.getElementById("profilepicfile").setCustomValidity("Upload an image file.");
                document.getElementById("profilepicfile").value = "";
            } else {
                img.src = e.target.result;
                document.getElementById("profilepicfile").setCustomValidity("");
                var MAX_WIDTH = 96;
                var MAX_HEIGHT = 96;
                var width = img.width;
                var height = img.height;
                if (width > height) {
                    var pourcentage = MAX_WIDTH/width;
                    width = MAX_WIDTH;
                    height = height*pourcentage;
                } else {
                    var pourcentage = MAX_HEIGHT/height;
                    height = MAX_HEIGHT;
                    width = width*pourcentage;
                }
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                var dataurl = canvas.toDataURL("image/png");
                document.getElementById("profilepic").value = dataurl;
            };
        }
        reader.readAsDataURL(file);
    }
    validatePwd = function(e) {
        var mdp1 = document.getElementById('pwd1');
        var mdp2 = document.getElementById('pwd2');
        if (mdp1.checkValidity() && mdp1.value==mdp2.value) { document.getElementById('pwd2').setCustomValidity(''); }
        else { document.getElementById('pwd2').setCustomValidity('Passwords should not be different.'); }
    }
</script>

<h1><%= username %></h1>
<a href="/profile">Back</a>
<form method="post" action="/changes">
    <p>
        <label>Password:</label>
        <input type="password" id="pwd_old" name="password" pattern="[a-zA-Z0-9]{6,8}" placeholder="Type your old password" required autofocus>
    </p>
    <p>
        <label>First name:</label>
        <input type="text" name="firstname" placeholder="" required value="<%= firstname %>">
    </p>
    <p>
        <label>Last name:</label>
        <input type="text" name="lastname" placeholder="" required value="<%= lastname %>">
    </p>
    <p>
        <label>Email:</label>
        <input type="email" name="email" placeholder="email@example.com" required value="<%= email %>">
    </p>
    <p>
        <label>Birthdate:</label>
        <input type="date" id="birthdate" name="birthdate" placeholder="DD/MM/YYYY" onchange="computeAge()" required value="<%= birthdate %>">
    </p>
    <p>
        <label>Age:</label>
        <input type="number" id="age" name="age" onload="computeAge()" disabled/>
    </p>
    <p>
        <label>City:</label>
        <input type="text" name="city" required placeholder="Current location" value="<%= city %>"/>
    </p>
    <p>
        <label>Color:</label>
        <input type="color" name="color" required value="<%= color %>"/>
    </p>
    <p>
        <label>Profile picture:</label>
        <input type="file" id="profilepicfile" onchange="loadProfilePic(this)">
        <canvas id="preview" width="0" height="0"></canvas>
    </p>
    <p>
        <label>Password:</label>
        <input type="password" id="pwd1" name="password" pattern="[a-zA-Z0-9]{6,8}" placeholder="a-zA-Z0-9 | length:6-8" onkeyup="validatePwd()" required>
    </p>
    <p>
        <label>Password:</label>
        <input type="password" id="pwd2" name="password2" placeholder="Repeat password" onkeyup="validatePwd()" required>
    </p>
    <p>
        <input type="submit" value="Send changes">
    </p>
</form>
<a href="/">home</a>
<a href="/login">login</a>
<a href="/register">register</a>
<% include foot %>